name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install clang tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy

    - name: Check code formatting
      run: |
        echo "## Code Formatting Check" >> $GITHUB_STEP_SUMMARY
        # Find all C++ source files in src/ (excluding third-party/external code)
        FILES=$(find src -name '*.cpp' -o -name '*.h' | grep -v '/third_party/' | grep -v '/external/')

        # Check formatting and report differences
        UNFORMATTED=""
        for FILE in $FILES; do
          if ! clang-format --dry-run --Werror "$FILE" 2>/dev/null; then
            UNFORMATTED="$UNFORMATTED $FILE"
          fi
        done

        if [ -n "$UNFORMATTED" ]; then
          echo "The following files need formatting:" >> $GITHUB_STEP_SUMMARY
          for FILE in $UNFORMATTED; do
            echo "- $FILE" >> $GITHUB_STEP_SUMMARY
          done
          echo ""
          echo "Run 'clang-format -i <file>' or './scripts/format-code.sh' to fix."
          # Report but don't fail initially (set exit 1 to enforce)
          echo "::warning::Code formatting issues found in $(echo $UNFORMATTED | wc -w) files"
        else
          echo "All files are properly formatted." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Run clang-tidy on platform code
      run: |
        echo "## Clang-Tidy Analysis" >> $GITHUB_STEP_SUMMARY
        # Focus on platform/linux code for now (new code should be clean)
        PLATFORM_FILES=$(find src/platform/linux -name '*.cpp' -o -name '*.h' 2>/dev/null || true)

        if [ -n "$PLATFORM_FILES" ]; then
          echo "Analyzing platform/linux code..." >> $GITHUB_STEP_SUMMARY

          # Run clang-tidy and capture output
          TIDY_OUTPUT=""
          for FILE in $PLATFORM_FILES; do
            OUTPUT=$(clang-tidy "$FILE" -- -std=c++17 -I src 2>&1 || true)
            if echo "$OUTPUT" | grep -q "warning:"; then
              TIDY_OUTPUT="$TIDY_OUTPUT\n$OUTPUT"
            fi
          done

          if [ -n "$TIDY_OUTPUT" ]; then
            echo "Clang-tidy found some issues (informational):" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Clang-tidy found potential issues in platform code"
          else
            echo "No issues found in platform/linux code." >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "No platform/linux files to analyze." >> $GITHUB_STEP_SUMMARY
        fi

  build-linux-stub:
    name: Linux Stub Build & Verification
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make

    - name: Configure CMake
      run: cmake -B build -DBUILD_LINUX_STUB=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run Static Analysis
      run: ./scripts/ci_static_analysis.sh

    - name: Check for Win32 type leakage in core
      run: |
        # Count Win32 type usages (excluding template parameters)
        # Baseline: 56 usages. Goal: 0.
        COUNT=$(grep -r "HWND\|DWORD\|MSG\|WPARAM\|LPARAM" src/core --include="*.cpp" --include="*.h" | grep -v "template.*WPARAM_T\|template.*LPARAM_T" | wc -l)
        echo "Win32 type leakage count: $COUNT"
        if [ "$COUNT" -gt 56 ]; then
          echo "ERROR: Win32 types leaked into src/core (Count: $COUNT, Limit: 56)"
          exit 1
        fi

    - name: Check legacy string usage
      run: |
        bash scripts/track_legacy_strings.sh > metrics.txt
        LEGACY_COUNT=$(grep "TOTAL legacy string usages:" metrics.txt | awk '{print $5}')
        echo "Legacy string usages: $LEGACY_COUNT"
        # Fail if count increases (baseline: 971)
        if [ "$LEGACY_COUNT" -gt 971 ]; then
          echo "ERROR: Legacy string usage increased!"
          exit 1
        fi

  regression-tests:
    name: Linux Regression Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make \
          libx11-dev libxrandr-dev libudev-dev \
          xvfb

    - name: Configure CMake
      run: cmake -B build -DBUILD_LINUX_STUB=ON -DBUILD_REGRESSION_TESTS=ON

    - name: Build regression tests
      run: cmake --build build --target yamy_regression_test --parallel

    - name: Run regression tests with Xvfb
      run: |
        xvfb-run -a ./build/bin/yamy_regression_test --gtest_output=xml:test-results.xml
      env:
        DISPLAY: :99

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: test-results.xml

    - name: Report test summary
      if: always()
      run: |
        if [ -f test-results.xml ]; then
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          # Extract test counts from gtest XML output
          TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          ERRORS=$(grep -o 'errors="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          echo "- Total tests: ${TESTS:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- Failures: ${FAILURES:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: ${ERRORS:-0}" >> $GITHUB_STEP_SUMMARY
        fi

  build-windows-mingw:
    name: Windows MinGW Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install MinGW
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 cmake

    - name: Configure CMake
      run: cmake -B build_mingw -DCMAKE_TOOLCHAIN_FILE=scripts/mingw_toolchain.cmake

    - name: Build
      run: cmake --build build_mingw --parallel
