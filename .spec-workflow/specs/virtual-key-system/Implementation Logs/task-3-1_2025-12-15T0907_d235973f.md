# Implementation Log: Task 3.1

**Summary:** Verified and documented substitution layer support for virtual keys (V_*, M00-MFF, L00-LFF). Enhanced Layer 2 and Layer 3 comments with concrete examples showing how virtual keys are handled in substitution and suppressed from evdev output.

**Timestamp:** 2025-12-15T09:07:30.221Z
**Log ID:** d235973f-0730-4afe-8e89-6cab6dfc74ff

---

## Statistics

- **Lines Added:** +16
- **Lines Removed:** -6
- **Files Changed:** 1
- **Net Change:** 10

## Files Modified
- src/core/engine/engine_event_processor.cpp

## Files Created
_No files created_

---

## Artifacts

### Functions

#### layer2_applySubstitution
- **Purpose:** Applies substitution table lookups to map physical keys to either other physical keys or virtual keys (V_*, M00-MFF, L00-LFF). Handles tap/hold detection for modifiers before substitution.
- **Location:** src/core/engine/engine_event_processor.cpp:128
- **Signature:** uint16_t layer2_applySubstitution(uint16_t yamy_in, EventType type, input::ModifierState* io_modState)
- **Exported:** No

#### layer3_yamyToEvdev
- **Purpose:** Converts YAMY scan codes to evdev codes, suppressing all virtual keys (V_*, M00-MFF, L00-LFF) by returning 0 before attempting evdev conversion
- **Location:** src/core/engine/engine_event_processor.cpp:269
- **Signature:** uint16_t layer3_yamyToEvdev(uint16_t yamy)
- **Exported:** No

### Integrations

#### Integration
- **Description:** Substitution table already supports virtual key mappings using std::unordered_map<uint16_t, uint16_t>, allowing any-to-any mappings without code changes
- **Frontend Component:** Substitution table (m_substitutions)
- **Backend Endpoint:** N/A (in-memory data structure)
- **Data Flow:** Parser loads config → builds substitution table → Layer 2 lookup maps physical→virtual → Layer 3 suppresses virtual keys (return 0)

#### Integration
- **Description:** Virtual key suppression ensures V_*, M00-MFF, L00-LFF never reach evdev output layer
- **Frontend Component:** layer3_yamyToEvdev
- **Backend Endpoint:** isVirtualKey/isModifier/isLock helper functions
- **Data Flow:** Layer 3 checks key type → if virtual return 0 → otherwise convert YAMY→evdev → output to system

