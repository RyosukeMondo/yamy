# Tasks: M00 Integration Test Automation

- [x] 1. Create EventSimulator utility class
  - File: tests/test_utils/event_simulator.h (new)
  - File: tests/test_utils/event_simulator.cpp (new)
  - File: tests/CMakeLists.txt (modify - add test_utils)
  - Create EventSimulator class to inject events with proper timing and synchronization
  - Implement event injection with configurable delays between events
  - Add engine initialization synchronization (waitForEngineReady)
  - Add output synchronization (waitForOutput for mock injector)
  - Handle evdev codes properly
  - Purpose: Provide test infrastructure for reliable event simulation with timing control
  - _Leverage: MockInputInjector interface, Engine::getState(), std::chrono for timing_
  - _Requirements: US-4 (Reproducible Test Scenarios)_
  - _Prompt: Role: Test Infrastructure Engineer | Task: Implement the EventSimulator utility class for M00 integration tests in spec m00-integration-test-automation. Create a new EventSimulator class that provides event injection with configurable delays between events, engine initialization synchronization (waitForEngineReady), output synchronization (waitForOutput for mock injector), and proper evdev code handling | Restrictions: Do NOT modify existing test files yet, do NOT use busy-wait loops (use proper sleep/condition variables), do NOT hardcode timeout values (make them configurable) | Success: EventSimulator compiles, provides timing control, and synchronization helpers work correctly. Can be included in test files and used for event injection_

- [ ] 2. Add integration test logging to EventProcessor and ModifierKeyHandler
  - File: src/core/engine/engine_event_processor.cpp (modify)
  - File: src/core/engine/modifier_key_handler.cpp (modify)
  - Add detailed logging for test debugging
  - Log event input (evdev code), modifier activation, rule matching, output generation
  - Include timestamps for timing verification
  - Make logs conditional on YAMY_DEBUG_KEYCODE or similar flag
  - Use [TEST] prefix for easy filtering
  - Include hex codes for keys/scancodes
  - Purpose: Provide comprehensive observability for debugging integration tests
  - _Leverage: Logger infrastructure (LOG_DEBUG, LOG_INFO), m_debugLogging flag in EventProcessor, printf to stderr for fallback_
  - _Requirements: US-3 (Comprehensive Observability)_
  - _Prompt: Role: Observability Engineer | Task: Add comprehensive logging to M00 event processing for spec m00-integration-test-automation. Add DEBUG-level logging to EventProcessor::processEvent() (log input, modifier checks, rule lookups, outputs), ModifierKeyHandler::checkAndActivateWaitingModifiers() (log threshold checks, activations), and ModifierKeyHandler::processNumberKey() (log state transitions WAITING → ACTIVE). Use [TEST] prefix for easy filtering and include hex codes for keys/scancodes | Restrictions: Do NOT change any logic only add logging, do NOT log on every event (only when m_debugLogging is true or env var set), do NOT add excessive logging that impacts performance | Success: Running tests with YAMY_DEBUG_KEYCODE=1 shows detailed event flow, state transitions, and timing. Existing functionality unchanged_

- [ ] 3. Fix EngineTestFixture initialization and synchronization
  - File: tests/test_m00_integration.cpp (modify)
  - Update test fixture to properly initialize Engine and wait for readiness before injecting events
  - Add waitForEngineReady() call in loadJsonConfig()
  - Increase wait from 100ms to 500ms after setSetting() for EventProcessor registration
  - Update injectKey() to use evdev codes properly
  - Add yamyToEvdev() conversion helper function
  - Convert YAMY scan codes to evdev codes (0x1e → 30 for A key)
  - Purpose: Eliminate race conditions during initialization and ensure proper timing
  - _Leverage: EventSimulator from Task 1, yamyToEvdevKeyCode() function if available, std::this_thread::sleep_for_
  - _Requirements: US-2 (Root Cause Investigation), US-4 (Reproducible Test Scenarios)_
  - _Prompt: Role: Test Infrastructure Engineer | Task: Fix the EngineTestFixture initialization and event injection in spec m00-integration-test-automation. Fix the test fixture to wait for Engine to be fully initialized after start(), wait additional time after setSetting() for EventProcessor to register triggers, use EventSimulator from Task 1 for event injection, and convert YAMY scan codes to evdev codes (0x1e → 30 for A key). In loadJsonConfig() add waitForEngineReady() call and increase wait from 100ms to 500ms after setSetting(). Update injectKey() to use evdev codes properly. Add yamyToEvdev() conversion helper | Restrictions: Do NOT re-enable tests yet (that's Task 5), do NOT change test logic only fix setup and timing, do NOT remove DISABLED_ prefix yet | Success: Test fixture initializes properly, logs show M00 trigger registration before events are injected, no race conditions during initialization_

- [ ] 4. Update test methods with proper timing and synchronization
  - File: tests/test_m00_integration.cpp (modify)
  - Update all 5 test methods to use EventSimulator with proper timing
  - TapAShouldOutputB: Use injectSequence with 100ms delay
  - HoldAPlusShouldOutputD: Use 250ms delay to exceed threshold
  - VimModeSemicolonPlusHOutputsLeft: Proper hold + combo timing
  - VimModeSemicolonTapOutputsSemicolon: Tap timing <200ms
  - VimModeAllArrowKeys: Multiple hold+key combinations
  - Use waitForOutput() to sync with async processing before assertions
  - Purpose: Ensure reliable hold/tap detection with proper timing
  - _Leverage: EventSimulator from Task 1, evdev code mapping (A=30, S=31, H=35, J=36, K=37, L=38, Semicolon=39), waitForOutput() for synchronization_
  - _Requirements: US-4 (Reproducible Test Scenarios)_
  - _Prompt: Role: Test Engineer | Task: Update M00 integration test methods to use proper timing and synchronization for spec m00-integration-test-automation. Update each test method (still DISABLED for now) to use EventSimulator.injectSequence with proper delays: TapAShouldOutputB (100ms delay), HoldAPlusShouldOutputD (250ms delay to exceed threshold), VimModeSemicolonPlusHOutputsLeft (proper hold + combo timing), VimModeSemicolonTapOutputsSemicolon (tap timing <200ms), VimModeAllArrowKeys (multiple hold+key combinations). Use pattern: std::vector<EventSimulator::Event> events with press/release and delays, then simulator.injectSequence(engine, events) and waitForOutput(mockInjector, 1000) | Restrictions: Do NOT remove DISABLED_ prefix yet (Task 5 does that), do NOT change expected outputs only fix timing/sync, do NOT add new test cases fix existing 5 tests only | Success: All 5 test methods use EventSimulator, have proper timing, wait for processing before assertions_

- [ ] 5. Re-enable all tests and verify reliability
  - File: tests/test_m00_integration.cpp (modify)
  - File: CMakeLists.txt or test runner config (if needed)
  - Remove DISABLED_ prefix from all 5 tests
  - Remove comment blocks explaining why tests were disabled
  - Build and run tests to verify they pass consistently
  - Run 10 consecutive times to verify no flaky failures
  - Debug with YAMY_DEBUG_KEYCODE=1 if any test fails
  - Purpose: Enable automated integration testing with reliable test execution
  - _Leverage: Logging from Task 2 for debugging, EventSimulator timing control from Task 1, CMake build system_
  - _Requirements: US-1 (Automated Integration Testing), US-2 (Root Cause Investigation)_
  - _Prompt: Role: QA Engineer | Task: Re-enable all M00 integration tests and verify reliability for spec m00-integration-test-automation. Remove DISABLED_ prefix from all 5 tests (TapAShouldOutputB, HoldAPlusShouldOutputD, VimModeSemicolonPlusHOutputsLeft, VimModeSemicolonTapOutputsSemicolon, VimModeAllArrowKeys). Remove comment blocks explaining why tests were disabled. Build and run tests. If any test fails check logs with YAMY_DEBUG_KEYCODE=1, verify timing values, check synchronization (waitForOutput timeout), fix and re-test. Run 10 times to verify: for i in {1..10}; do ./build_ninja/bin/yamy_m00_integration_test || exit 1; done | Restrictions: Do NOT disable tests again fix the issue if they fail, do NOT skip verification must pass 10 consecutive times, do NOT proceed if execution time >10 seconds | Success: All 5 tests pass consistently, total execution <10s, test output shows clear pass/fail. Tests pass 10 consecutive times with no flaky failures_

- [ ] 6. Document testing approach and integrate with CI/CD
  - File: tests/README.md or docs/testing.md (new/modify)
  - File: .github/workflows/tests.yml or CI config (modify)
  - Document M00 test architecture (EventSimulator, timing, synchronization)
  - Document how to run tests locally
  - Document how to debug test failures (YAMY_DEBUG_KEYCODE=1)
  - Add M00 integration test job to CI (GitHub Actions or similar)
  - Run tests on pull requests
  - Report results (pass/fail + execution time)
  - Block merge if tests fail
  - Purpose: Enable automated CI/CD integration and provide clear maintenance documentation
  - _Leverage: Existing CI configuration (.github/workflows/ or similar), CMake test targets, GitHub Actions or CI platform docs_
  - _Requirements: US-5 (CI/CD Integration)_
  - _Prompt: Role: DevOps Engineer | Task: Document testing approach and integrate M00 tests into CI/CD for spec m00-integration-test-automation. Create/update documentation explaining how M00 integration tests work (EventSimulator, timing, synchronization), how to run tests locally, how to debug test failures (YAMY_DEBUG_KEYCODE=1), and optionally include test architecture diagram. Update CI/CD to add M00 integration test job to GitHub Actions/CI, run tests on pull requests, report results (pass/fail + execution time), and block merge if tests fail | Restrictions: Do NOT skip documentation critical for maintenance, do NOT allow CI failures to be ignored, do NOT add flaky test detection tests must be reliable | Success: Tests run automatically in CI, documentation is clear, team can maintain tests without manual UAT. CI blocks merges on test failures_
