# YAMY IPC Protocol (GUI)

This document describes the IPC contract between the GUI/CLI clients and the yamy engine. It focuses on GUI-facing control/notification messages used by `IPCChannelQt` and the daemon-side `IPCControlServer`.

## Transport and Framing
- **Daemon control socket:** `/tmp/yamy-engine.sock` (UNIX domain stream). Used by the engine to receive control commands. Frame = 8-byte header `{ uint32 type; uint32 dataSize; }` followed by `dataSize` bytes. Values are written in native endianness; this channel is always local.
- **Qt IPC channel:** `/tmp/yamy-{name}-{UID}` (UNIX domain stream) generated by `IPCChannelQt`. Frame = 4-byte big-endian length prefix (includes the 4-byte message type + payload), then 4-byte big-endian `MessageType`, then raw payload bytes.
- **Message struct in code:** `ipc::Message { MessageType type; const void* data; size_t size; }`.
- **Size limits:** Daemon rejects payloads > 1 MiB. Qt channel relies on `INT_MAX` guard when serializing.
- **Character encoding:** Payload strings are UTF-8; binary structs use the layouts defined in `core/ipc_messages.h`.

## Message Catalog

| Type (hex) | Direction | Payload | Description |
| --- | --- | --- | --- |
| `0x1001` CmdInvestigateWindow | GUI → Daemon | `InvestigateWindowRequest { platform::WindowHandle hwnd; }` | Request investigation of a specific window handle. |
| `0x1002` RspInvestigateWindow | Daemon → GUI | `InvestigateWindowResponse { char keymapName[256]; char matchedClassRegex[256]; char matchedTitleRegex[256]; char activeModifiers[256]; bool isDefault; }` | Investigation result. |
| `0x1003` CmdEnableInvestigateMode | GUI → Daemon | (empty) | Enable live investigate mode. |
| `0x1004` CmdDisableInvestigateMode | GUI → Daemon | (empty) | Disable live investigate mode. |
| `0x1005` NtfKeyEvent | Daemon → GUI | `KeyEventNotification { char keyEvent[256]; }` | Live key event notification during investigate mode. |
| `0x2001` CmdReload | GUI/CLI → Daemon | UTF-8 config name (may be empty for current) | Reload configuration. |
| `0x2002` CmdStop | GUI/CLI → Daemon | (empty) | Stop engine. |
| `0x2003` CmdStart | GUI/CLI → Daemon | (empty) | Start engine. |
| `0x2004` CmdGetStatus | GUI/CLI → Daemon | (empty) | Request engine status. |
| `0x2005` CmdGetConfig | GUI/CLI → Daemon | UTF-8 config selector (e.g., `"active"`) | Request config details. |
| `0x2006` CmdGetKeymaps | GUI/CLI → Daemon | (empty) | Request loaded keymaps list. |
| `0x2007` CmdGetMetrics | GUI/CLI → Daemon | UTF-8 metrics filter (optional, e.g., `"latency-only"`) | Request performance metrics. |
| `0x2100` RspOk | Daemon → GUI/CLI | UTF-8 message or empty | Command succeeded. |
| `0x2101` RspError | Daemon → GUI/CLI | UTF-8 error message | Command failed. |
| `0x2102` RspStatus | Daemon → GUI/CLI | JSON string | Engine status response. |
| `0x2103` RspConfig | Daemon → GUI/CLI | JSON string | Config details response. |
| `0x2104` RspKeymaps | Daemon → GUI/CLI | JSON string | Keymaps response. |
| `0x2105` RspMetrics | Daemon → GUI/CLI | JSON string | Metrics response. |

## Payload Examples (from test fixtures)
- Status request/response: `CmdGetStatus` (empty payload) → `RspStatus` payload `{"engine_running":true,"enabled":true}`.
- Config request: `CmdGetConfig` payload `"active"` → `RspConfig` payload `{"active_config":"mock.mayu"}`.
- Keymaps request: `CmdGetKeymaps` (empty) → `RspKeymaps` payload `{"keymaps":["mock","layered"]}`.
- Metrics request: `CmdGetMetrics` payload `"latency-only"` → `RspMetrics` payload `{"latency_ns":1024}`.
- Reload request: `CmdReload` payload `"reload:mock"` → `RspOk` payload `"OK"` on success or `RspError` with reason.
- Investigate window: `CmdInvestigateWindow` payload `InvestigateWindowRequest{ hwnd = 0xCAFEBABE }` → `RspInvestigateWindow` with populated fields; live events then arrive as `NtfKeyEvent` with text like `"[12:00:00.000] Ctrl-Alt-K pressed"`.

## Typical Flows
- **Status poll:** `CmdGetStatus` → `RspStatus` (JSON). Use to update GUI connection indicator.
- **Enable/disable investigate:** `CmdEnableInvestigateMode` → `RspOk`; during session consume `NtfKeyEvent`; end via `CmdDisableInvestigateMode`.
- **Config management:** `CmdReload` (config name optional) → `RspOk`/`RspError`; `CmdGetConfig`/`CmdGetKeymaps` to populate UI selectors.
- **Engine lifecycle:** `CmdStart`/`CmdStop` with empty payloads → `RspOk`/`RspError`.

## Troubleshooting
- **No response / EPIPE:** Confirm daemon is listening on `/tmp/yamy-engine.sock` (`lsof -U | grep yamy-engine.sock`). For Qt channel, ensure client/server use the same name/UID so the socket path matches.
- **Payload size mismatch:** Daemon enforces 1 MiB cap; Qt side drops messages larger than `INT_MAX`. Ensure length prefix (`IPCChannelQt`) or `dataSize` header (`IPCControlServer`) matches payload length.
- **Wrong endianness:** Qt channel uses big-endian length and type fields. Do not reuse daemon header format on the Qt path.
- **Type IDs drift:** The `tests/test_ipc_protocol.cpp` fixture validates all numeric IDs; run those tests if message numbers change.
- **Content inspection:** Set `YAMY_DEBUG_IPC=1` and run `tools/debug_ipc_communication.sh --attach` to tee traffic, or use `tests/mock_ipc_server.cpp` to simulate daemon replies during GUI development.
