{
  "id": "snapshot_1765379658654_whuuvjauc",
  "approvalId": "approval_1765379658651_3hu5b46oy",
  "approvalTitle": "Spec: Requirements (Linux Complete Port)",
  "version": 1,
  "timestamp": "2025-12-10T15:14:18.654Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements: Linux Complete Port\n\n## Overview\n\nComplete feature-parity Linux port of YAMY keyboard remapping utility, ensuring identical functionality and user experience across Windows and Linux platforms.\n\n---\n\n## User Stories\n\n### US-1: Cross-Platform Developer Workflow\n**As a** software developer working on both Windows and Linux\n**I want** to use the same .mayu configuration file on both systems\n**So that** my muscle memory and keyboard shortcuts work identically everywhere\n\n**Acceptance Criteria**:\n- [ ] Same .mayu file works without modification on Windows and Linux\n- [ ] All keyboard shortcuts behave identically\n- [ ] Configuration changes sync seamlessly\n- [ ] No platform-specific syntax required\n\n**EARS Criteria**:\n- **Event**: When I copy my .mayu file from Windows to Linux\n- **Action**: YAMY loads and applies the configuration\n- **Result**: All key mappings work identically\n\n---\n\n### US-2: System Tray Control\n**As a** power user\n**I want** a system tray icon with context menu\n**So that** I can quickly enable/disable remapping and switch configurations\n\n**Acceptance Criteria**:\n- [ ] System tray icon visible in all major DEs (GNOME, KDE, XFCE)\n- [ ] Visual indication of enabled/disabled state (green/gray icon)\n- [ ] Right-click opens context menu\n- [ ] Double-click toggles enable/disable\n- [ ] Menu includes: Enable, Reload, Settings, Log, About, Exit\n\n**EARS Criteria**:\n- **Event**: When I right-click the tray icon\n- **Action**: A context menu appears\n- **Result**: I can access all YAMY functions\n\n---\n\n### US-3: Configuration Management\n**As a** user with multiple keyboard layouts\n**I want** to manage multiple .mayu configurations and switch between them\n**So that** I can adapt to different workflows (work, gaming, writing)\n\n**Acceptance Criteria**:\n- [ ] Can add/edit/remove multiple configurations\n- [ ] Each configuration has: name, .mayu file path, preprocessor symbols\n- [ ] Reload submenu lists all configurations with checkmark on active\n- [ ] Configuration changes persist across restarts\n- [ ] Can reorder configurations\n\n**EARS Criteria**:\n- **Event**: When I select a configuration from the Reload submenu\n- **Action**: YAMY loads and activates that configuration\n- **Result**: All keymappings reflect the new config within 100ms\n\n---\n\n### US-4: Real-Time Debugging\n**As a** keymap developer\n**I want** an investigate dialog showing window information and key events\n**So that** I can debug window-specific bindings and verify key capture\n\n**Acceptance Criteria**:\n- [ ] Crosshair tool to select target window\n- [ ] Displays: window handle, class name, title, position, size\n- [ ] Keyboard input test field showing captured keys with modifiers\n- [ ] Updates in real-time as focus changes\n- [ ] Enables engine log mode when focused\n\n**EARS Criteria**:\n- **Event**: When I focus the keyboard input field\n- **Action**: Engine log mode activates\n- **Result**: Every key press shows in log with scancode, VK, and modifiers\n\n---\n\n### US-5: Log Monitoring\n**As a** troubleshooting user\n**I want** a log viewer with filtering and export\n**So that** I can diagnose configuration errors and report bugs\n\n**Acceptance Criteria**:\n- [ ] Timestamped log entries\n- [ ] Auto-scroll toggle\n- [ ] Detail level control (0=minimal, 1=verbose)\n- [ ] Clear log function\n- [ ] Save to file (.log or .txt)\n- [ ] Font customization\n- [ ] 10,000 line limit with automatic trimming\n\n**EARS Criteria**:\n- **Event**: When engine encounters an error\n- **Action**: Error appears in log dialog\n- **Result**: User sees timestamp, error type, and detailed message\n\n---\n\n### US-6: Settings Management\n**As a** new user\n**I want** a GUI settings dialog\n**So that** I can configure keymaps without editing text files\n\n**Acceptance Criteria**:\n- [ ] Three-column table: Name, Path, Symbols\n- [ ] Add button opens file picker for .mayu files\n- [ ] Edit button opens edit dialog for selected config\n- [ ] Remove button deletes configuration with confirmation\n- [ ] Up/Down buttons reorder configurations\n- [ ] Double-click opens edit dialog\n- [ ] Save button persists changes\n- [ ] Cancel button discards changes\n\n**EARS Criteria**:\n- **Event**: When I click Add and select a .mayu file\n- **Action**: File is added to configuration list\n- **Result**: Configuration appears in table and Reload submenu\n\n---\n\n### US-7: Engine Integration\n**As a** user\n**I want** the Linux engine to process keyboard input identically to Windows\n**So that** all functions work (window commands, mouse control, clipboard, etc.)\n\n**Acceptance Criteria**:\n- [ ] All 100+ functions from Windows version implemented\n- [ ] evdev input capture from all keyboards\n- [ ] uinput event injection\n- [ ] X11 window manipulation\n- [ ] Focus tracking with window class/title matching\n- [ ] Modifier state tracking (Ctrl, Alt, Shift, Meta)\n- [ ] Lock key handling (Caps, Num, Scroll)\n- [ ] Sub-millisecond latency (99th percentile <1ms)\n\n**EARS Criteria**:\n- **Event**: When I press a remapped key\n- **Action**: Engine processes via keymap lookup\n- **Result**: Correct action executes within 1ms\n\n---\n\n### US-8: Multi-Keyboard Support (Linux-Specific)\n**As a** Linux user with multiple keyboards\n**I want** separate keymaps for different keyboards\n**So that** my laptop keyboard and external keyboard can have different layouts\n\n**Acceptance Criteria**:\n- [ ] Detect all connected keyboards via evdev\n- [ ] Assign keymap per device\n- [ ] Hot-plug support (keyboards connect/disconnect)\n- [ ] Device-specific configuration in .mayu file\n- [ ] GUI shows device list with names\n\n**EARS Criteria**:\n- **Event**: When I connect a new USB keyboard\n- **Action**: YAMY detects device and applies default keymap\n- **Result**: New keyboard works with remapping immediately\n\n---\n\n### US-9: Session Management (Linux-Specific)\n**As a** laptop user\n**I want** YAMY to handle screen lock and suspend gracefully\n**So that** remapping doesn't interfere with login or cause input issues after wake\n\n**Acceptance Criteria**:\n- [ ] Pause engine on screen lock\n- [ ] Resume engine on unlock\n- [ ] Suspend all input on system suspend\n- [ ] Restore state after resume\n- [ ] No stuck keys after lock/unlock\n- [ ] Detect session events via D-Bus\n\n**EARS Criteria**:\n- **Event**: When the system is suspended\n- **Action**: YAMY pauses engine and releases all keys\n- **Result**: After resume, no keys are stuck and remapping works normally\n\n---\n\n### US-10: Performance Expectations\n**As a** competitive typist / gamer\n**I want** zero perceptible input lag\n**So that** YAMY doesn't slow down my workflow or gameplay\n\n**Acceptance Criteria**:\n- [ ] Latency: 99th percentile <1ms, mean <500μs\n- [ ] CPU usage: <1% idle, <3% under load\n- [ ] Memory: <10MB resident set size\n- [ ] No frame drops or stutters during heavy input\n- [ ] Benchmark mode for profiling\n\n**EARS Criteria**:\n- **Event**: When I type at 120 WPM\n- **Action**: YAMY processes all keys without lag\n- **Result**: No perceptible delay, all keys registered correctly\n\n---\n\n### US-11: External Control (IPC API)\n**As a** automation scripter\n**I want** a command-line or D-Bus API to control YAMY\n**So that** I can enable/disable remapping from scripts\n\n**Acceptance Criteria**:\n- [ ] D-Bus service: `net.gimy.yamy`\n- [ ] Methods: Enable(bool), Reload(), Quit(), GetStatus()\n- [ ] Command-line tool: `yamy-ctl enable|disable|reload|quit|status`\n- [ ] Responds within 10ms\n- [ ] Works from any user process\n\n**EARS Criteria**:\n- **Event**: When I run `yamy-ctl disable`\n- **Action**: YAMY receives command via D-Bus\n- **Result**: Remapping is disabled and command returns exit code 0\n\n---\n\n### US-12: Help and Documentation\n**As a** first-time user\n**I want** accessible help and examples\n**So that** I can quickly learn how to configure YAMY\n\n**Acceptance Criteria**:\n- [ ] Help menu item opens browser with documentation\n- [ ] About dialog shows version, build date, license\n- [ ] Example .mayu files included (Emacs bindings, Vim bindings)\n- [ ] Tooltip hints in dialogs\n- [ ] Error messages link to troubleshooting docs\n\n**EARS Criteria**:\n- **Event**: When I click Help menu\n- **Action**: Browser opens to documentation website\n- **Result**: User guide is displayed\n\n---\n\n## Functional Requirements\n\n### FR-1: Core Refactoring\n**Priority**: CRITICAL\n**Dependencies**: None\n**Description**: Remove all Windows-specific types from core engine to enable Linux compilation\n\n**Requirements**:\n- FR-1.1: Replace `HWND` with `yamy::platform::WindowHandle` throughout codebase\n- FR-1.2: Replace `tstring` with `std::string` throughout codebase\n- FR-1.3: Replace `SW_*` constants with `yamy::platform::ShowCommand` enum\n- FR-1.4: Abstract `PostMessage`/`SendMessage` with `IIPCChannel` interface\n- FR-1.5: Remove `GetWindowRect`, `MoveWindow`, etc. → use `IWindowSystem`\n- FR-1.6: Clean up `ConfigStore` - remove `tstring` overloads\n- FR-1.7: Abstract GDI calls (BeginPaint, EndPaint, DrawIcon)\n- FR-1.8: Abstract window messages (WM_KEYDOWN, WM_SETFOCUS)\n- FR-1.9: Abstract caret functions (CreateCaret, ShowCaret)\n- FR-1.10: Remove all `windowstool.h` includes from core\n\n**Acceptance**: Engine compiles on Linux without Windows headers\n\n---\n\n### FR-2: Configuration Management System\n**Priority**: HIGH\n**Dependencies**: FR-1\n**Description**: Multi-configuration support with GUI editor\n\n**Requirements**:\n- FR-2.1: `MayuConfiguration` struct with name/path/symbols\n- FR-2.2: QSettings storage format: `keymaps/configs/N`, `keymaps/activeIndex`\n- FR-2.3: `ConfigManagerQt` class with CRUD operations\n- FR-2.4: Configuration serialization to \"name;path;symbols\" format\n- FR-2.5: Dynamic reload submenu population\n- FR-2.6: Configuration switching via menu\n- FR-2.7: Three-column settings dialog (Name/Path/Symbols)\n- FR-2.8: Up/Down reordering buttons\n- FR-2.9: Edit setting dialog with browse button\n- FR-2.10: Validation (name required, path must exist)\n\n**Acceptance**: User can manage 10+ configurations via GUI\n\n---\n\n### FR-3: Investigate Dialog\n**Priority**: MEDIUM\n**Dependencies**: FR-1\n**Description**: Real-time debugging tool with window inspector\n\n**Requirements**:\n- FR-3.1: Crosshair window selector tool\n- FR-3.2: Window info display (handle, thread ID, class, title, geometry)\n- FR-3.3: MDI window detection\n- FR-3.4: Keyboard input test field\n- FR-3.5: VK code and modifier display (E-/U-/D- format)\n- FR-3.6: Scancode display\n- FR-3.7: Log mode toggle on focus\n- FR-3.8: Position persistence (QSettings)\n- FR-3.9: Relative positioning near log dialog\n\n**Acceptance**: User can inspect any window and capture key events\n\n---\n\n### FR-4: Log Dialog Enhancement\n**Priority**: MEDIUM\n**Dependencies**: FR-1\n**Description**: Full-featured log viewer matching Windows version\n\n**Requirements**:\n- FR-4.1: Detail level checkbox (0=minimal, 1=verbose)\n- FR-4.2: Font selection dialog\n- FR-4.3: Font persistence (QSettings: `ui/logFont`)\n- FR-4.4: Engine log streaming integration\n- FR-4.5: Startup banner display\n- FR-4.6: Real-time log append (Qt signals)\n- FR-4.7: Monospace font default\n- FR-4.8: Line wrap toggle (optional enhancement)\n\n**Acceptance**: Log dialog matches Windows functionality\n\n---\n\n### FR-5: Engine Notification System\n**Priority**: CRITICAL\n**Dependencies**: FR-1\n**Description**: Engine-to-GUI communication for dynamic updates\n\n**Requirements**:\n- FR-5.1: `EngineNotifierQt` class with Qt signals\n- FR-5.2: Handle `EngineNotify_shellExecute` → `QProcess::startDetached`\n- FR-5.3: Handle `EngineNotify_loadSetting` → reload config\n- FR-5.4: Handle `EngineNotify_helpMessage` → show tray balloon\n- FR-5.5: Handle `EngineNotify_showDlg` → show/hide dialogs\n- FR-5.6: Handle `EngineNotify_setForegroundWindow` → X11 focus change\n- FR-5.7: Handle `EngineNotify_clearLog` → clear log dialog\n- FR-5.8: Engine callback registration\n- FR-5.9: Signal/slot connections to GUI\n- FR-5.10: Thread-safe notification delivery\n\n**Acceptance**: All 6 notification types trigger correct GUI actions\n\n---\n\n### FR-6: IPC API for External Control\n**Priority**: LOW\n**Dependencies**: FR-1, FR-5\n**Description**: D-Bus service for programmatic control\n\n**Requirements**:\n- FR-6.1: D-Bus service interface definition\n- FR-6.2: Method: `Enable(bool enabled)` → engine.enable()/disable()\n- FR-6.3: Method: `Reload()` → reload active configuration\n- FR-6.4: Method: `Quit()` → QApplication::quit()\n- FR-6.5: Method: `GetStatus()` → return enabled state\n- FR-6.6: Command-line tool `yamy-ctl` wrapping D-Bus calls\n- FR-6.7: Shell completion script (bash/zsh)\n- FR-6.8: Systemd service unit (optional)\n\n**Acceptance**: `yamy-ctl disable` works from terminal\n\n---\n\n### FR-7: Session Management\n**Priority**: MEDIUM\n**Dependencies**: FR-1\n**Description**: Handle Linux session events gracefully\n\n**Requirements**:\n- FR-7.1: D-Bus listener for `org.freedesktop.login1.SessionRemoved`\n- FR-7.2: D-Bus listener for `org.freedesktop.ScreenSaver.ActiveChanged`\n- FR-7.3: D-Bus listener for `org.freedesktop.login1.PrepareForSleep`\n- FR-7.4: Engine pause on screen lock\n- FR-7.5: Engine resume on unlock\n- FR-7.6: Release all pressed keys on pause\n- FR-7.7: Reinitialize key state on resume\n- FR-7.8: Log session events to debug log\n\n**Acceptance**: No stuck keys after lock/unlock/suspend\n\n---\n\n### FR-8: Keyboard State Checker\n**Priority**: LOW\n**Dependencies**: FR-3 (can be part of Investigate dialog)\n**Description**: Display all key states for debugging\n\n**Requirements**:\n- FR-8.1: List of all pressed keys (from engine)\n- FR-8.2: Lock key states (Caps, Num, Scroll)\n- FR-8.3: Modifier states (Shift, Ctrl, Alt, Meta)\n- FR-8.4: Refresh on timer (100ms)\n- FR-8.5: Highlight state changes\n- FR-8.6: Export state to clipboard\n\n**Acceptance**: Shows accurate key states in real-time\n\n---\n\n### FR-9: Help Menu\n**Priority**: LOW\n**Dependencies**: None\n**Description**: Link to documentation\n\n**Requirements**:\n- FR-9.1: Help menu item in tray context menu\n- FR-9.2: Opens default browser with `QDesktopServices::openUrl()`\n- FR-9.3: URL points to GitHub wiki or docs site\n- FR-9.4: Fallback to local HTML docs if offline\n\n**Acceptance**: Help opens documentation in browser\n\n---\n\n## Non-Functional Requirements\n\n### NFR-1: Performance\n**Priority**: CRITICAL\n\n- NFR-1.1: Input latency: 99th percentile <1ms, mean <500μs\n- NFR-1.2: CPU usage: <1% idle, <3% under heavy load (500+ keys/sec)\n- NFR-1.3: Memory: <10MB RSS (excluding Qt GUI)\n- NFR-1.4: Startup time: <1 second to tray icon visible\n- NFR-1.5: Configuration reload: <100ms\n\n---\n\n### NFR-2: Compatibility\n**Priority**: HIGH\n\n- NFR-2.1: Supports X11 (Xorg)\n- NFR-2.2: Basic Wayland support via XWayland\n- NFR-2.3: Works on GNOME, KDE, XFCE, i3, Sway\n- NFR-2.4: Kernel 4.19+ (for evdev/uinput APIs)\n- NFR-2.5: Qt 5.12+ (LTS)\n- NFR-2.6: GCC 7+ or Clang 8+\n- NFR-2.7: All .mayu files from Windows version work unchanged\n\n---\n\n### NFR-3: Usability\n**Priority**: HIGH\n\n- NFR-3.1: System tray icon visible on all DEs\n- NFR-3.2: Dialogs remember size/position\n- NFR-3.3: No configuration required for basic use (defaults work)\n- NFR-3.4: Error messages are actionable (not cryptic)\n- NFR-3.5: Keyboard-navigable dialogs (Tab, Enter, Esc)\n\n---\n\n### NFR-4: Reliability\n**Priority**: HIGH\n\n- NFR-4.1: No crashes during normal operation\n- NFR-4.2: Graceful degradation if Qt not available (headless mode)\n- NFR-4.3: Handle keyboard hot-plug without restart\n- NFR-4.4: Recover from X11 server disconnect\n- NFR-4.5: No stuck keys even on abnormal exit\n\n---\n\n### NFR-5: Maintainability\n**Priority**: MEDIUM\n\n- NFR-5.1: Code coverage: 80% minimum\n- NFR-5.2: All public APIs documented (Doxygen)\n- NFR-5.3: No platform-specific code in core/ directory\n- NFR-5.4: CMake builds on both Windows and Linux\n- NFR-5.5: CI pipeline tests both platforms\n\n---\n\n### NFR-6: Security\n**Priority**: MEDIUM\n\n- NFR-6.1: No setuid/setgid binaries\n- NFR-6.2: Runs as regular user (input group membership)\n- NFR-6.3: .mayu files are user-created (trusted by design)\n- NFR-6.4: No network access (local only)\n- NFR-6.5: No telemetry or data collection\n\n---\n\n## Out of Scope\n\nThe following are explicitly NOT part of this spec:\n\n- ❌ Wayland native protocol support (future work)\n- ❌ macOS port\n- ❌ Mobile keyboards (Android/iOS)\n- ❌ Cloud configuration sync\n- ❌ Visual keymap editor (drag-and-drop)\n- ❌ Plugin/scripting system (Lua)\n- ❌ Mouse remapping (out of project scope)\n- ❌ Macro recording (out of project scope)\n\n---\n\n## Success Criteria\n\nRelease v1.0 is considered complete when:\n\n1. ✅ All user stories US-1 through US-12 are implemented\n2. ✅ All functional requirements FR-1 through FR-9 are implemented\n3. ✅ All non-functional requirements NFR-1 through NFR-6 are met\n4. ✅ Zero P0 bugs in issue tracker\n5. ✅ Community beta testing (20+ users, 2+ weeks)\n6. ✅ Documentation complete (user guide, API docs, examples)\n7. ✅ Benchmarks pass on 3 reference systems (laptop, desktop, server)\n\n---\n\n**Document Version**: 1.0\n**Last Updated**: 2025-12-10\n**Status**: Draft (Pending Approval)\n**Reviewed By**: (Pending)\n",
  "fileStats": {
    "size": 17003,
    "lines": 524,
    "lastModified": "2025-12-10T15:01:11.669Z"
  },
  "comments": []
}