name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-linux-stub:
    name: Linux Stub Build & Verification
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make

    - name: Configure CMake
      run: cmake -B build -DBUILD_LINUX_STUB=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run Static Analysis
      run: ./scripts/ci_static_analysis.sh

    - name: Check for Win32 type leakage in core
      run: |
        # Count Win32 type usages (excluding template parameters)
        # Baseline: 56 usages. Goal: 0.
        COUNT=$(grep -r "HWND\|DWORD\|MSG\|WPARAM\|LPARAM" src/core --include="*.cpp" --include="*.h" | grep -v "template.*WPARAM_T\|template.*LPARAM_T" | wc -l)
        echo "Win32 type leakage count: $COUNT"
        if [ "$COUNT" -gt 56 ]; then
          echo "ERROR: Win32 types leaked into src/core (Count: $COUNT, Limit: 56)"
          exit 1
        fi

    - name: Check legacy string usage
      run: |
        bash scripts/track_legacy_strings.sh > metrics.txt
        LEGACY_COUNT=$(grep "TOTAL legacy string usages:" metrics.txt | awk '{print $5}')
        echo "Legacy string usages: $LEGACY_COUNT"
        # Fail if count increases (baseline: 23)
        if [ "$LEGACY_COUNT" -gt 23 ]; then
          echo "ERROR: Legacy string usage increased!"
          exit 1
        fi

  build-windows-mingw:
    name: Windows MinGW Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install MinGW
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 cmake

    - name: Configure CMake
      run: cmake -B build_mingw -DCMAKE_TOOLCHAIN_FILE=scripts/mingw_toolchain.cmake

    - name: Build
      run: cmake --build build_mingw --parallel
