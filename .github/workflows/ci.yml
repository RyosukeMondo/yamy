name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-linux-stub:
    name: Linux Stub Build & Verification
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make

    - name: Configure CMake
      run: cmake -B build -DBUILD_LINUX_STUB=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run Static Analysis
      run: ./scripts/ci_static_analysis.sh

    - name: Check for Win32 type leakage in core
      run: |
        # Count Win32 type usages (excluding template parameters)
        # Baseline: 56 usages. Goal: 0.
        COUNT=$(grep -r "HWND\|DWORD\|MSG\|WPARAM\|LPARAM" src/core --include="*.cpp" --include="*.h" | grep -v "template.*WPARAM_T\|template.*LPARAM_T" | wc -l)
        echo "Win32 type leakage count: $COUNT"
        if [ "$COUNT" -gt 56 ]; then
          echo "ERROR: Win32 types leaked into src/core (Count: $COUNT, Limit: 56)"
          exit 1
        fi

    - name: Check legacy string usage
      run: |
        bash scripts/track_legacy_strings.sh > metrics.txt
        LEGACY_COUNT=$(grep "TOTAL legacy string usages:" metrics.txt | awk '{print $5}')
        echo "Legacy string usages: $LEGACY_COUNT"
        # Fail if count increases (baseline: 971)
        if [ "$LEGACY_COUNT" -gt 971 ]; then
          echo "ERROR: Legacy string usage increased!"
          exit 1
        fi

  regression-tests:
    name: Linux Regression Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make \
          libx11-dev libxrandr-dev libudev-dev \
          xvfb

    - name: Configure CMake
      run: cmake -B build -DBUILD_LINUX_STUB=ON -DBUILD_REGRESSION_TESTS=ON

    - name: Build regression tests
      run: cmake --build build --target yamy_regression_test --parallel

    - name: Run regression tests with Xvfb
      run: |
        xvfb-run -a ./build/bin/yamy_regression_test --gtest_output=xml:test-results.xml
      env:
        DISPLAY: :99

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: test-results.xml

    - name: Report test summary
      if: always()
      run: |
        if [ -f test-results.xml ]; then
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          # Extract test counts from gtest XML output
          TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          ERRORS=$(grep -o 'errors="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          echo "- Total tests: ${TESTS:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- Failures: ${FAILURES:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: ${ERRORS:-0}" >> $GITHUB_STEP_SUMMARY
        fi

  build-windows-mingw:
    name: Windows MinGW Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install MinGW
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 cmake

    - name: Configure CMake
      run: cmake -B build_mingw -DCMAKE_TOOLCHAIN_FILE=scripts/mingw_toolchain.cmake

    - name: Build
      run: cmake --build build_mingw --parallel
