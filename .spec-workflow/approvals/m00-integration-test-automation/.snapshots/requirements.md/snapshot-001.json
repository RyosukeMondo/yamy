{
  "id": "snapshot_1766076073992_s064zvwy6",
  "approvalId": "approval_1766076073978_38ngk6ims",
  "approvalTitle": "Requirements: M00 Integration Test Automation",
  "version": 1,
  "timestamp": "2025-12-18T16:41:13.992Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements: M00 Integration Test Automation\n\n## Problem Statement\n\nWe are stuck in a manual debugging loop for M00 virtual modifier functionality. The current approach has critical flaws:\n\n1. **Integration tests are DISABLED** - we disabled 5 tests claiming \"mock environment limitations\" instead of fixing them\n2. **Manual UAT required** - asking users to manually press keys to verify behavior\n3. **No automated verification** - can't prove M00 works without human testing\n4. **Low productivity** - endless debug cycles with no systematic approach\n5. **Wrong assumption**: \"integration tests can't work in mock environment\" - this is false, they SHOULD work\n\n**Root Issue**: For a keyboard remapper between OS and application, EVERYTHING is under control and should be fully automated. No manual UAT should be needed.\n\n## User Stories\n\n### US-1: Automated Integration Testing\n**As a** developer\n**I want** M00 integration tests to pass automatically\n**So that** I can verify functionality without manual testing\n\n**EARS Criteria**:\n- **WHEN** integration tests run\n- **IF** M00 virtual modifiers are configured\n- **THEN** tests SHALL verify tap/hold behavior automatically\n- **AND** tests SHALL pass without human interaction\n\n**Acceptance Criteria**:\n- All 5 disabled M00 integration tests are re-enabled and passing\n- Tests run in <10 seconds\n- Tests can run in CI/CD pipeline\n- No manual key presses required\n\n### US-2: Root Cause Investigation\n**As a** developer\n**I want** to understand why integration tests failed\n**So that** I can fix the real issue instead of working around it\n\n**EARS Criteria**:\n- **WHEN** investigating test failures\n- **IF** tests show \"no output generated\"\n- **THEN** investigation SHALL identify the actual bug\n- **AND** fix SHALL address root cause, not symptoms\n\n**Acceptance Criteria**:\n- Document exact failure mode (why mock injector not called)\n- Identify if bug is in: test setup, Engine code, or EventProcessor\n- Fix eliminates the root cause\n- Tests pass reliably\n\n### US-3: Comprehensive Observability\n**As a** developer\n**I want** detailed logging of M00 event processing\n**So that** I can diagnose issues without manual debugging\n\n**EARS Criteria**:\n- **WHEN** M00 events are processed\n- **IF** debug logging is enabled\n- **THEN** system SHALL log: trigger registration, hold/tap detection, modifier activation, rule matching\n- **AND** logs SHALL include timestamps and event sequences\n\n**Acceptance Criteria**:\n- Log M00 trigger registration with key codes\n- Log PRESS/RELEASE events with timing\n- Log hold threshold checks (waiting → active transitions)\n- Log rule lookup and matching\n- Log output generation\n- Logs are structured and parseable\n\n### US-4: Reproducible Test Scenarios\n**As a** developer\n**I want** declarative test scenarios\n**So that** I can verify complex M00 behavior reliably\n\n**EARS Criteria**:\n- **WHEN** defining test scenarios\n- **IF** testing tap vs hold behavior\n- **THEN** tests SHALL use time-based event sequences\n- **AND** tests SHALL verify exact output without race conditions\n\n**Acceptance Criteria**:\n- Test framework supports timed event injection\n- Tests verify: tap output, hold suppression, M00+key remapping\n- Tests wait for async processing properly\n- Tests are deterministic (no flaky failures)\n\n### US-5: CI/CD Integration\n**As a** developer\n**I want** tests to run in CI/CD automatically\n**So that** regressions are caught before deployment\n\n**EARS Criteria**:\n- **WHEN** code is committed\n- **IF** M00 functionality changes\n- **THEN** CI SHALL run integration tests\n- **AND** deployment SHALL be blocked if tests fail\n\n**Acceptance Criteria**:\n- Tests run in GitHub Actions / CI\n- Test results are reported clearly\n- Failed tests block merge\n- Coverage report shows M00 code paths tested\n\n## Non-Functional Requirements\n\n### NFR-1: Performance\n- Integration tests complete in <10 seconds total\n- Individual test cases run in <2 seconds\n- No timeouts or hangs\n\n### NFR-2: Reliability\n- Tests pass 100% consistently (no flaky tests)\n- Tests work on clean checkout (no manual setup)\n- Tests clean up after themselves\n\n### NFR-3: Maintainability\n- Test code is well-documented\n- Test failures have clear error messages\n- Adding new test cases is straightforward\n\n## Out of Scope\n\n- GUI testing (focus on Engine/EventProcessor integration)\n- Performance benchmarking (functional tests only)\n- Multi-threading stress tests\n- Hardware device testing (use mocks)\n\n## Success Metrics\n\n1. **All 5 disabled tests re-enabled and passing** ✅\n2. **Zero manual UAT required** - commit with confidence\n3. **Test execution time <10 seconds**\n4. **100% test reliability** - no flaky failures\n5. **Coverage >90%** for M00 code paths\n\n## Dependencies\n\n- Existing M00 unit tests (already passing)\n- Engine architecture (EventProcessor, ModifierKeyHandler)\n- Test infrastructure (GoogleTest framework)\n- Mock implementations (InputInjector, InputHook, InputDriver)\n\n## Assumptions\n\n1. M00 logic itself is correct (unit tests prove this)\n2. Problem is in integration test setup, not M00 implementation\n3. Mock environment CAN fully simulate real runtime\n4. EventProcessor design supports testability\n\n## Risks\n\n1. **Root cause might be deep** - could require Engine refactoring\n2. **Thread timing issues** - async operations need careful handling\n3. **Test infrastructure gaps** - might need new test utilities\n\n## Notes\n\nThis spec addresses the fundamental question: **\"Why are we debugging manually when everything should be automated?\"**\n\nThe answer requires:\n1. Finding the real bug (not disabling tests)\n2. Fixing test infrastructure\n3. Proving it works automatically\n4. Never needing manual UAT again\n",
  "fileStats": {
    "size": 5684,
    "lines": 165,
    "lastModified": "2025-12-18T16:41:06.766Z"
  },
  "comments": []
}