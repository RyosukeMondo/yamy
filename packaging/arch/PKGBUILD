# Maintainer: YAMY Project <yamy@example.com>
# PKGBUILD for YAMY - Cross-platform keyboard remapper

pkgname=yamy
pkgver=1.0.0
pkgrel=1
pkgdesc="Cross-platform keyboard remapper - customize keyboard behavior, create macros, and remap keys"
arch=('x86_64')
url="https://github.com/ryosukemondo/yamy"
license=('BSD-3-Clause')
depends=(
    'qt5-base'
    'qt5-x11extras'
    'libx11'
    'libxrandr'
    'systemd-libs'  # for libudev
)
makedepends=(
    'cmake'
    'gcc'
    'pkgconf'
)
optdepends=(
    'xorg-server: X11 server for keyboard remapping'
)
provides=('yamy')
conflicts=('yamy-git')
source=("$pkgname-$pkgver.tar.gz::$url/archive/v$pkgver.tar.gz")
# Use SKIP for development; replace with actual sha256sum for release
sha256sums=('SKIP')
install=yamy.install

build() {
    cd "$pkgname-$pkgver"

    cmake -B build \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DBUILD_QT_GUI=ON \
        -DBUILD_LINUX_TESTING=OFF \
        -DBUILD_REGRESSION_TESTS=OFF \
        -Wno-dev

    cmake --build build
}

check() {
    cd "$pkgname-$pkgver"
    # Run basic smoke test if possible
    # Skip full test suite as it requires X11 display
    :
}

package() {
    cd "$pkgname-$pkgver"

    DESTDIR="$pkgdir" cmake --install build

    # Install license
    install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

    # Install udev rules for input device access
    install -Dm644 /dev/stdin "$pkgdir/usr/lib/udev/rules.d/99-yamy-input.rules" << 'EOF'
# YAMY keyboard remapper - input device access rules
# This allows members of the 'input' group to access keyboard devices

# Grant read access to input event devices for 'input' group
KERNEL=="event*", SUBSYSTEM=="input", MODE="0660", GROUP="input"

# Grant read access to keyboard devices specifically
SUBSYSTEM=="input", ATTRS{name}=="*keyboard*", MODE="0660", GROUP="input"
SUBSYSTEM=="input", ATTRS{name}=="*Keyboard*", MODE="0660", GROUP="input"
EOF
}
