{
  "id": "snapshot_1766076704604_aieuf7dxp",
  "approvalId": "approval_1766076704595_8p0mvuspo",
  "approvalTitle": "Tasks: M00 Integration Test Automation",
  "version": 1,
  "timestamp": "2025-12-18T16:51:44.604Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks: M00 Integration Test Automation\n\n## Overview\n\nThis spec fixes the root cause of integration test failures and eliminates manual debugging. All tasks focus on making tests work reliably and automatically.\n\n**Total Tasks**: 6\n**Estimated Effort**: 8-12 hours\n**Priority**: Critical - blocks automated verification\n\n---\n\n## Task 1: Create EventSimulator Utility\n\n**Status**: [ ] Pending\n\n**Description**: Create EventSimulator class to inject events with proper timing and synchronization\n\n**Files**:\n- `tests/test_utils/event_simulator.h` (new)\n- `tests/test_utils/event_simulator.cpp` (new)\n- `tests/CMakeLists.txt` (modify - add test_utils)\n\n**Requirements**: US-4 (Reproducible Test Scenarios)\n\n**Success Criteria**:\n- EventSimulator can inject sequences with timing\n- `waitForEngineReady()` polls engine status\n- `waitForOutput()` waits for mock injector calls\n- Compiles without errors\n- Can be included in test files\n\n**_Prompt**:\n```\nRole: Test Infrastructure Engineer\n\nTask: Implement the EventSimulator utility class for M00 integration tests in spec m00-integration-test-automation. First run spec-workflow-guide to get the workflow guide then implement the task.\n\nCreate a new EventSimulator class that provides:\n1. Event injection with configurable delays between events\n2. Engine initialization synchronization (waitForEngineReady)\n3. Output synchronization (waitForOutput for mock injector)\n4. Proper evdev code handling\n\nRestrictions:\n- Do NOT modify existing test files yet (that's Task 3)\n- Do NOT use busy-wait loops (use proper sleep/condition variables)\n- Do NOT hardcode timeout values (make them configurable)\n\nLeverage:\n- Existing MockInputInjector interface\n- Engine::getState() or similar status check\n- std::chrono for timing\n\nRequirements: US-4 (Reproducible Test Scenarios)\n\nSuccess: EventSimulator compiles, provides timing control, and synchronization helpers work correctly\n\nAfter implementation:\n1. Edit tasks.md: Change this task from [ ] to [-] before starting\n2. Implement the EventSimulator class\n3. Log implementation with log-implementation tool including all artifacts (classes, functions, etc.)\n4. Edit tasks.md: Change this task from [-] to [x] when complete\n```\n\n---\n\n## Task 2: Add Integration Test Logging\n\n**Status**: [ ] Pending\n\n**Description**: Add detailed logging to EventProcessor and ModifierKeyHandler for test debugging\n\n**Files**:\n- `src/core/engine/engine_event_processor.cpp` (modify)\n- `src/core/engine/modifier_key_handler.cpp` (modify)\n\n**Requirements**: US-3 (Comprehensive Observability)\n\n**Success Criteria**:\n- Logs show: event input (evdev code), modifier activation, rule matching, output generation\n- Logs include timestamps for timing verification\n- Logs are conditional on YAMY_DEBUG_KEYCODE or similar flag\n- Existing functionality unchanged\n\n**_Prompt**:\n```\nRole: Observability Engineer\n\nTask: Add comprehensive logging to M00 event processing for spec m00-integration-test-automation. First run spec-workflow-guide to get the workflow guide then implement the task.\n\nAdd DEBUG-level logging to:\n1. EventProcessor::processEvent() - log input, modifier checks, rule lookups, outputs\n2. ModifierKeyHandler::checkAndActivateWaitingModifiers() - log threshold checks, activations\n3. ModifierKeyHandler::processNumberKey() - log state transitions (WAITING → ACTIVE)\n\nLog format: [TEST] prefix for easy filtering, include hex codes for keys/scancodes\n\nRestrictions:\n- Do NOT change any logic, only add logging\n- Do NOT log on every event (only when m_debugLogging is true or env var set)\n- Do NOT add excessive logging that impacts performance\n\nLeverage:\n- Existing Logger infrastructure (LOG_DEBUG, LOG_INFO)\n- Existing m_debugLogging flag in EventProcessor\n- printf to stderr for fallback if logger unavailable\n\nRequirements: US-3 (Comprehensive Observability)\n\nSuccess: Running tests with YAMY_DEBUG_KEYCODE=1 shows detailed event flow, state transitions, and timing\n\nAfter implementation:\n1. Edit tasks.md: Change this task from [ ] to [-] before starting\n2. Add logging to EventProcessor and ModifierKeyHandler\n3. Log implementation with log-implementation tool\n4. Edit tasks.md: Change this task from [-] to [x] when complete\n```\n\n---\n\n## Task 3: Fix EngineTestFixture Initialization\n\n**Status**: [ ] Pending\n\n**Description**: Update test fixture to properly initialize Engine and wait for readiness before injecting events\n\n**Files**:\n- `tests/test_m00_integration.cpp` (modify)\n\n**Requirements**: US-2 (Root Cause Investigation), US-4 (Reproducible Test Scenarios)\n\n**Success Criteria**:\n- Engine::start() completes fully before tests inject events\n- Setting application waits for EventProcessor registration\n- loadJsonConfig() uses proper synchronization\n- Tests use evdev codes (not YAMY scan codes)\n- No race conditions during initialization\n\n**_Prompt**:\n```\nRole: Test Infrastructure Engineer\n\nTask: Fix the EngineTestFixture initialization and event injection in spec m00-integration-test-automation. First run spec-workflow-guide to get the workflow guide then implement the task.\n\nFix the test fixture to:\n1. Wait for Engine to be fully initialized after start()\n2. Wait additional time after setSetting() for EventProcessor to register triggers\n3. Use EventSimulator from Task 1 for event injection\n4. Convert YAMY scan codes to evdev codes (0x1e → 30 for A key)\n\nKey fixes:\n- In loadJsonConfig(): Add waitForEngineReady() call\n- In loadJsonConfig(): Increase wait from 100ms to 500ms after setSetting()\n- Update injectKey() to use evdev codes properly\n- Add helper: yamyToEvdev() conversion function\n\nRestrictions:\n- Do NOT re-enable tests yet (that's Task 5)\n- Do NOT change test logic, only fix setup and timing\n- Do NOT remove DISABLED_ prefix yet\n\nLeverage:\n- EventSimulator from Task 1\n- Existing yamyToEvdevKeyCode() function if available\n- std::this_thread::sleep_for for waits\n\nRequirements: US-2 (Root Cause Investigation), US-4 (Reproducible Test Scenarios)\n\nSuccess: Test fixture initializes properly, logs show M00 trigger registration before events are injected\n\nAfter implementation:\n1. Edit tasks.md: Change this task from [ ] to [-] before starting\n2. Fix EngineTestFixture setup and timing\n3. Log implementation with log-implementation tool\n4. Edit tasks.md: Change this task from [-] to [x] when complete\n```\n\n---\n\n## Task 4: Fix Event Timing and Synchronization\n\n**Status**: [ ] Pending\n\n**Description**: Update test methods to use EventSimulator with proper timing for hold/tap detection\n\n**Files**:\n- `tests/test_m00_integration.cpp` (modify)\n\n**Requirements**: US-4 (Reproducible Test Scenarios)\n\n**Success Criteria**:\n- Tests inject events with proper delays (e.g., 250ms hold time)\n- Tests wait for async processing to complete\n- Tests verify output after synchronization\n- No hardcoded sleeps - use EventSimulator\n\n**_Prompt**:\n```\nRole: Test Engineer\n\nTask: Update M00 integration test methods to use proper timing and synchronization for spec m00-integration-test-automation. First run spec-workflow-guide to get the workflow guide then implement the task.\n\nUpdate each test method (still DISABLED for now):\n1. TapAShouldOutputB - Use EventSimulator.injectSequence with 100ms delay\n2. HoldAPlusShouldOutputD - Use 250ms delay to exceed threshold\n3. VimModeSemicolonPlusHOutputsLeft - Proper hold + combo timing\n4. VimModeSemicolonTapOutputsSemicolon - Tap timing <200ms\n5. VimModeAllArrowKeys - Multiple hold+key combinations\n\nPattern for each test:\n```cpp\nstd::vector<EventSimulator::Event> events = {\n    {evdev_code, true, 0},        // Press\n    {evdev_code, false, delay_ms} // Release after delay\n};\nsimulator.injectSequence(engine, events);\nASSERT_TRUE(simulator.waitForOutput(mockInjector, 1000));\n```\n\nRestrictions:\n- Do NOT remove DISABLED_ prefix yet (Task 5 does that)\n- Do NOT change expected outputs - only fix timing/sync\n- Do NOT add new test cases - fix existing 5 tests only\n\nLeverage:\n- EventSimulator from Task 1\n- evdev code mapping: A=30, S=31, H=35, J=36, K=37, L=38, Semicolon=39\n- waitForOutput() to sync with async processing\n\nRequirements: US-4 (Reproducible Test Scenarios)\n\nSuccess: All 5 test methods use EventSimulator, have proper timing, wait for processing before assertions\n\nAfter implementation:\n1. Edit tasks.md: Change this task from [ ] to [-] before starting\n2. Update all 5 test methods with proper timing\n3. Log implementation with log-implementation tool\n4. Edit tasks.md: Change this task from [-] to [x] when complete\n```\n\n---\n\n## Task 5: Re-enable and Verify All Tests\n\n**Status**: [ ] Pending\n\n**Description**: Remove DISABLED_ prefix from all 5 tests and verify they pass consistently\n\n**Files**:\n- `tests/test_m00_integration.cpp` (modify)\n- `CMakeLists.txt` or test runner config (if needed)\n\n**Requirements**: US-1 (Automated Integration Testing), US-2 (Root Cause Investigation)\n\n**Success Criteria**:\n- All 5 tests have DISABLED_ prefix removed\n- All tests pass when run individually\n- All tests pass when run together\n- Tests pass 10 consecutive times (no flaky failures)\n- Test execution time <10 seconds total\n\n**_Prompt**:\n```\nRole: QA Engineer\n\nTask: Re-enable all M00 integration tests and verify reliability for spec m00-integration-test-automation. First run spec-workflow-guide to get the workflow guide then implement the task.\n\nSteps:\n1. Remove DISABLED_ prefix from all 5 tests:\n   - DISABLED_TapAShouldOutputB → TapAShouldOutputB\n   - DISABLED_HoldAPlusShouldOutputD → HoldAPlusShouldOutputD\n   - DISABLED_VimModeSemicolonPlusHOutputsLeft → VimModeSemicolonPlusHOutputsLeft\n   - DISABLED_VimModeSemicolonTapOutputsSemicolon → VimModeSemicolonTapOutputsSemicolon\n   - DISABLED_VimModeAllArrowKeys → VimModeAllArrowKeys\n\n2. Remove the comment blocks explaining why tests were disabled\n\n3. Build and run tests: `./build_ninja/bin/yamy_m00_integration_test`\n\n4. If any test fails:\n   - Check logs with YAMY_DEBUG_KEYCODE=1\n   - Verify timing values (may need adjustment)\n   - Check synchronization (waitForOutput timeout)\n   - Fix and re-test\n\n5. Run 10 times to verify: `for i in {1..10}; do ./build_ninja/bin/yamy_m00_integration_test || exit 1; done`\n\nRestrictions:\n- Do NOT disable tests again - fix the issue if they fail\n- Do NOT skip verification - must pass 10 consecutive times\n- Do NOT proceed if execution time >10 seconds\n\nLeverage:\n- Logging from Task 2 for debugging\n- EventSimulator timing control from Task 1\n- Build system (cmake)\n\nRequirements: US-1 (Automated Integration Testing), US-2 (Root Cause Investigation)\n\nSuccess: All 5 tests pass consistently, total execution <10s, test output shows clear pass/fail\n\nAfter implementation:\n1. Edit tasks.md: Change this task from [ ] to [-] before starting\n2. Re-enable all tests and verify reliability\n3. Log implementation with log-implementation tool including test results\n4. Edit tasks.md: Change this task from [-] to [x] when complete\n```\n\n---\n\n## Task 6: Document Testing Approach and Add CI\n\n**Status**: [ ] Pending\n\n**Description**: Document the automated testing approach and add tests to CI/CD pipeline\n\n**Files**:\n- `tests/README.md` or `docs/testing.md` (new/modify)\n- `.github/workflows/tests.yml` or CI config (modify)\n\n**Requirements**: US-5 (CI/CD Integration)\n\n**Success Criteria**:\n- Documentation explains M00 test architecture\n- CI runs integration tests on every commit\n- CI reports test results clearly\n- Failed tests block merges\n\n**_Prompt**:\n```\nRole: DevOps Engineer\n\nTask: Document testing approach and integrate M00 tests into CI/CD for spec m00-integration-test-automation. First run spec-workflow-guide to get the workflow guide then implement the task.\n\nCreate/update documentation:\n1. How M00 integration tests work (EventSimulator, timing, synchronization)\n2. How to run tests locally\n3. How to debug test failures (YAMY_DEBUG_KEYCODE=1)\n4. Test architecture diagram (optional)\n\nUpdate CI/CD:\n1. Add M00 integration test job to GitHub Actions / CI\n2. Run tests on pull requests\n3. Report results (pass/fail + execution time)\n4. Block merge if tests fail\n\nRestrictions:\n- Do NOT skip documentation - critical for maintenance\n- Do NOT allow CI failures to be ignored\n- Do NOT add flaky test detection - tests must be reliable\n\nLeverage:\n- Existing CI configuration (.github/workflows/ or similar)\n- CMake test targets\n- GitHub Actions or CI platform docs\n\nRequirements: US-5 (CI/CD Integration)\n\nSuccess: Tests run automatically in CI, documentation is clear, team can maintain tests without manual UAT\n\nAfter implementation:\n1. Edit tasks.md: Change this task from [ ] to [-] before starting\n2. Write documentation and update CI config\n3. Log implementation with log-implementation tool\n4. Edit tasks.md: Change this task from [-] to [x] when complete\n```\n\n---\n\n## Task Summary\n\n| Task | Component | Effort | Dependencies |\n|------|-----------|--------|--------------|\n| 1 | EventSimulator | 2h | None |\n| 2 | Logging | 1h | None |\n| 3 | Test Fixture | 2h | Task 1 |\n| 4 | Test Timing | 2h | Tasks 1, 3 |\n| 5 | Re-enable Tests | 2h | Tasks 1-4 |\n| 6 | Documentation/CI | 1h | Task 5 |\n\n**Total**: ~10 hours\n\n## Implementation Order\n\n1. **Foundation** (Tasks 1-2) - Can be done in parallel\n2. **Fix Infrastructure** (Task 3) - Requires Task 1\n3. **Fix Tests** (Task 4) - Requires Tasks 1, 3\n4. **Verification** (Task 5) - Requires Tasks 1-4\n5. **Integration** (Task 6) - Requires Task 5\n\n## Acceptance Criteria (Overall)\n\n- ✅ All 5 integration tests pass consistently\n- ✅ No DISABLED_ prefixes remain\n- ✅ Tests run in <10 seconds\n- ✅ Pass 100 consecutive runs (ultimate reliability test)\n- ✅ CI automatically runs tests\n- ✅ Zero manual UAT needed\n\n## Notes\n\n- Each task should be marked in-progress `[-]` before starting\n- Use log-implementation tool after EACH task completes\n- Mark complete `[x]` only after verification\n- If a task blocks, debug with YAMY_DEBUG_KEYCODE=1 logs\n",
  "fileStats": {
    "size": 13882,
    "lines": 407,
    "lastModified": "2025-12-18T16:49:21.730Z"
  },
  "comments": []
}