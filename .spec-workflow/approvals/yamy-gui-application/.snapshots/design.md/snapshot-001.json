{
  "id": "snapshot_1765710966723_2100kepw6",
  "approvalId": "approval_1765710966709_0bq9qxitp",
  "approvalTitle": "Design - YAMY GUI Application",
  "version": 1,
  "timestamp": "2025-12-14T11:16:06.723Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe YAMY GUI Application (`yamy-gui`) is a standalone Qt-based desktop application that provides a graphical control panel for the headless yamy daemon. The design adopts a client-server architecture where:\n\n- **yamy daemon**: Runs headless (no QApplication) as background process handling keyboard remapping\n- **yamy-gui**: Separate Qt application that connects to daemon via IPC for monitoring and control\n- **yamy-ctl**: Existing CLI tool for command-line control (unchanged)\n\nThis architecture completely eliminates the Qt/DBus system tray crash by avoiding system tray icons entirely. The GUI uses Qt5 widgets without platform-specific integrations that trigger DBus marshalling bugs.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThe design follows established YAMY patterns:\n- Qt5-based UI using existing widget components\n- IPC communication via IPCChannelQt (QLocalSocket)\n- ConfigManager singleton for configuration access\n- Settings persistence via QSettings\n- Logging integration with existing Logger infrastructure\n\n### Project Structure (structure.md)\n\nImplementation follows YAMY's modular organization:\n```\nsrc/app/\n  ├── main.cpp          # yamy daemon (headless, no GUI)\n  └── main_gui.cpp      # yamy-gui application (NEW)\n\nsrc/ui/qt/\n  ├── dialog_*.cpp/.h   # Existing dialogs (reused as-is)\n  ├── main_window_gui.cpp/.h  # NEW: Main control panel window\n  └── ipc_*.cpp/.h      # IPC communication wrappers\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **DialogLogQt**: Log viewer dialog with filtering - reused without modification\n- **DialogInvestigateQt**: Window investigation tool - reused without modification\n- **DialogSettingsQt**: Settings configuration dialog - reused without modification\n- **DialogAboutQt**: About dialog - reused without modification\n- **NotificationHistoryDialog**: Notification history viewer - reused without modification\n- **PreferencesDialog**: Application preferences - reused without modification\n- **ConfigManagerDialog**: Configuration management - reused without modification\n- **IPCChannelQt**: IPC client implementation - extended for GUI-specific commands\n- **ConfigManager**: Singleton configuration manager - accessed via IPC queries\n- **Logger**: Logging infrastructure - used for GUI-side logging\n\n### Integration Points\n\n- **IPC Protocol**: Extend existing yamy::ipc::Message protocol with GUI-specific commands:\n  - `CmdGetStatus`: Query daemon state (enabled/disabled, config name, error state)\n  - `CmdSetEnabled`: Enable/disable keyboard remapping\n  - `CmdSwitchConfig`: Switch to different configuration\n  - `CmdReloadConfig`: Reload current configuration file\n  - `RspStatus`: Status response with daemon state\n  - `RspError`: Error response with failure details\n\n- **Daemon Communication**: GUI connects to `/tmp/yamy-engine.sock` using IPCChannelQt\n- **Settings Storage**: Qt settings stored in `~/.config/yamy/yamy-gui.conf`\n- **Session Management**: Desktop entry `yamy-gui.desktop` for launcher integration\n\n## Architecture\n\n### High-Level Architecture\n\n```mermaid\ngraph TB\n    subgraph User Space\n        User[User]\n        GUI[yamy-gui<br/>Qt Application]\n        CLI[yamy-ctl<br/>CLI Tool]\n    end\n\n    subgraph Daemon\n        Daemon[yamy<br/>Headless Daemon]\n        Engine[Engine<br/>Core Logic]\n        IPC[IPC Server<br/>QLocalServer]\n    end\n\n    subgraph System\n        Input[/dev/input/*<br/>Keyboard Events]\n        uinput[/dev/uinput<br/>Virtual Device]\n    end\n\n    User -->|Launch| GUI\n    User -->|Command| CLI\n\n    GUI -->|IPC Commands| IPC\n    CLI -->|Socket Commands| IPC\n\n    IPC -->|Control| Engine\n    Engine -->|Read| Input\n    Engine -->|Inject| uinput\n\n    GUI -.->|Display Status| User\n    CLI -.->|Output| User\n```\n\n### Component Interaction Flow\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant GUI as yamy-gui\n    participant IPC as IPC Channel\n    participant Daemon as yamy daemon\n    participant Engine\n\n    User->>GUI: Launch yamy-gui\n    GUI->>IPC: Connect to /tmp/yamy-engine.sock\n    IPC-->>GUI: Connected\n\n    GUI->>IPC: Send CmdGetStatus\n    IPC->>Daemon: Forward message\n    Daemon->>Engine: Query state\n    Engine-->>Daemon: State data\n    Daemon->>IPC: RspStatus(enabled, config)\n    IPC-->>GUI: Receive response\n    GUI-->>User: Display status\n\n    User->>GUI: Click \"Disable\"\n    GUI->>IPC: Send CmdSetEnabled(false)\n    IPC->>Daemon: Forward message\n    Daemon->>Engine: engine->enable(false)\n    Engine-->>Daemon: Success\n    Daemon->>IPC: RspSuccess\n    IPC-->>GUI: Receive response\n    GUI-->>User: Update toggle button\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**:\n  - `main_window_gui.cpp`: Main window UI and layout only\n  - `ipc_client_gui.cpp`: IPC communication abstraction only\n  - Existing dialogs remain unchanged\n\n- **Component Isolation**:\n  - IPC layer completely isolated from UI components\n  - UI components communicate only via signals/slots\n  - No direct Engine dependencies in GUI code\n\n- **Service Layer Separation**:\n  - IPC client acts as service layer for GUI\n  - Configuration access via IPC queries (not direct ConfigManager calls)\n  - State management centralized in main window controller\n\n## Components and Interfaces\n\n### Component 1: MainWindowGUI\n\n- **Purpose:** Primary window providing status display and control buttons\n- **File:** `src/ui/qt/main_window_gui.cpp`, `src/ui/qt/main_window_gui.h`\n- **Interfaces:**\n  - `MainWindowGUI(QWidget* parent)`: Constructor\n  - `void connectToDaemon()`: Establish IPC connection\n  - `void refreshStatus()`: Request status update from daemon\n  - **Slots:**\n    - `void onToggleEnabled()`: Handle enable/disable button\n    - `void onSwitchConfig(int index)`: Handle configuration switch\n    - `void onReloadConfig()`: Handle reload button\n    - `void onShowLog()`: Launch log viewer dialog\n    - `void onShowInvestigate()`: Launch investigate dialog\n    - `void onShowSettings()`: Launch settings dialog\n    - `void onShowPreferences()`: Launch preferences dialog\n    - `void onShowNotificationHistory()`: Launch notification history\n    - `void onShowAbout()`: Launch about dialog\n  - **Signals:**\n    - `void statusChanged(bool enabled, QString configName)`\n    - `void connectionLost()`\n\n- **Dependencies:** IPCClientGUI, Qt5::Widgets\n- **Reuses:** All existing dialog classes (DialogLogQt, DialogInvestigateQt, etc.)\n\n### Component 2: IPCClientGUI\n\n- **Purpose:** High-level IPC wrapper providing GUI-specific communication methods\n- **File:** `src/ui/qt/ipc_client_gui.cpp`, `src/ui/qt/ipc_client_gui.h`\n- **Interfaces:**\n  - `IPCClientGUI(QObject* parent)`: Constructor\n  - `bool connectToDaemon()`: Connect to daemon IPC socket\n  - `void sendGetStatus()`: Request daemon status\n  - `void sendSetEnabled(bool enabled)`: Enable/disable remapping\n  - `void sendSwitchConfig(const QString& configPath)`: Switch configuration\n  - `void sendReloadConfig()`: Reload current configuration\n  - **Signals:**\n    - `void connected()`: IPC connection established\n    - `void disconnected()`: IPC connection lost\n    - `void statusReceived(bool enabled, QString configName, QString error)`\n    - `void commandSuccess()`: Command executed successfully\n    - `void commandError(QString message)`: Command failed\n\n- **Dependencies:** IPCChannelQt, yamy::ipc::Message\n- **Reuses:** IPCChannelQt for low-level socket communication\n\n### Component 3: Daemon IPC Server Extensions\n\n- **Purpose:** Add GUI-specific command handlers to existing IPC server\n- **File:** `src/core/platform/linux/ipc_control_server.cpp` (modifications)\n- **New Handlers:**\n  - `handleGetStatus()`: Return current daemon state\n  - `handleSetEnabled(bool enabled)`: Enable/disable engine\n  - `handleSwitchConfig(QString path)`: Switch configuration\n  - `handleReloadConfig()`: Reload current config\n\n- **Dependencies:** Engine, ConfigManager\n- **Reuses:** Existing IPC message protocol and serialization\n\n### Component 4: Headless Daemon Executable\n\n- **Purpose:** Run yamy daemon without QApplication to avoid Qt platform plugins\n- **File:** `src/app/main.cpp` (refactored)\n- **Changes:**\n  - Remove QApplication instantiation\n  - Remove system tray icon code (SystemTrayAppIndicator)\n  - Keep Engine initialization (no Qt dependency)\n  - Keep IPC server for communication\n  - Use QCoreApplication for Qt event loop (minimal Qt dependency)\n\n- **Dependencies:** Engine, IPCControlServer, QCoreApplication\n- **Reuses:** Existing Engine and IPC infrastructure\n\n## Data Models\n\n### DaemonStatus Model\n\n```cpp\nstruct DaemonStatus {\n    bool connected;          // IPC connection status\n    bool enabled;            // Keyboard remapping enabled/disabled\n    QString configName;      // Active configuration name\n    QString configPath;      // Active configuration path\n    QString errorMessage;    // Last error (if any)\n    QDateTime lastUpdate;    // Timestamp of last status update\n};\n```\n\n### IPCCommand Model\n\n```cpp\nenum class IPCCommandType {\n    GetStatus,\n    SetEnabled,\n    SwitchConfig,\n    ReloadConfig,\n    QueryKeymap  // For investigate window\n};\n\nstruct IPCCommand {\n    IPCCommandType type;\n    QVariantMap parameters;  // Command-specific params\n};\n```\n\n### IPCResponse Model\n\n```cpp\nenum class IPCResponseType {\n    Status,\n    Success,\n    Error\n};\n\nstruct IPCResponse {\n    IPCResponseType type;\n    QVariantMap data;        // Response payload\n    QString errorMessage;    // Error description (if type == Error)\n};\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Daemon Not Running**\n   - **Handling:** IPCClientGUI::connectToDaemon() returns false after retry attempts\n   - **User Impact:** Main window displays \"Daemon not running\" message with instructions:\n     ```\n     YAMY daemon is not running\n\n     Start daemon with: yamy &\n     Or enable autostart in system settings\n     ```\n\n2. **IPC Connection Lost During Operation**\n   - **Handling:** IPCChannelQt emits disconnected() signal, IPCClientGUI relays to GUI\n   - **User Impact:** Status bar shows \"Connection Lost\" in red, all controls disabled with tooltip:\n     ```\n     Connection to daemon lost\n     Click here to reconnect\n     ```\n\n3. **Configuration File Syntax Error on Reload**\n   - **Handling:** Daemon's parser returns error, sent via RspError message\n   - **User Impact:** Error dialog displays parser error details:\n     ```\n     Failed to reload configuration\n\n     Syntax error at line 42:\n     Invalid keymap definition\n\n     Please fix configuration file and retry.\n     ```\n\n4. **Invalid Configuration Path on Switch**\n   - **Handling:** Daemon validates path existence before switching, returns error if invalid\n   - **User Impact:** Notification shows:\n     ```\n     Configuration file not found:\n     /path/to/nonexistent.mayu\n     ```\n\n5. **Permission Denied on IPC Socket**\n   - **Handling:** QLocalSocket::connectToServer() fails with permission error\n   - **User Impact:** Error message:\n     ```\n     Permission denied accessing daemon socket\n\n     Check that yamy daemon is running as same user\n     Socket: /tmp/yamy-engine.sock\n     ```\n\n## Testing Strategy\n\n### Unit Testing\n\n- **IPCClientGUI Tests**: Mock IPCChannelQt to verify command generation and response handling\n- **MainWindowGUI Tests**: Mock IPCClientGUI to test UI state transitions\n- **IPC Message Tests**: Verify serialization/deserialization of GUI-specific commands\n- **Error Handling Tests**: Simulate connection failures, invalid responses, timeout scenarios\n\n### Integration Testing\n\n- **GUI-Daemon Communication**: Start real daemon, send commands from GUI, verify state changes\n- **Configuration Switching**: Test full flow of switching configs and verifying engine state\n- **Reconnection Logic**: Kill daemon during operation, restart it, verify GUI reconnects\n- **Multi-Instance Prevention**: Launch multiple yamy-gui instances, verify proper socket sharing\n\n### End-to-End Testing\n\n- **User Workflow: Enable/Disable**: Launch GUI, toggle remapping, verify keyboard behavior changes\n- **User Workflow: Config Switch**: Switch between test configs, verify different key mappings active\n- **User Workflow: Investigate Window**: Open investigate, select window, verify correct keymap shown\n- **User Workflow: Log Viewing**: Generate log events, view in log dialog, verify filtering works\n\n## Build System Integration\n\n### CMake Configuration\n\nAdd new executable target:\n\n```cmake\n# yamy-gui executable\nadd_executable(yamy-gui\n    src/app/main_gui.cpp\n    src/ui/qt/main_window_gui.cpp\n    src/ui/qt/ipc_client_gui.cpp\n)\n\ntarget_link_libraries(yamy-gui\n    yamy_qt_gui    # Existing Qt UI library (dialogs)\n    Qt5::Widgets\n    Qt5::Network\n)\n\ninstall(TARGETS yamy-gui DESTINATION bin)\n```\n\n### Desktop Entry\n\nInstall launcher file:\n\n```desktop\n[Desktop Entry]\nType=Application\nName=YAMY Control Panel\nComment=Keyboard remapping control panel\nExec=yamy-gui\nIcon=yamy\nCategories=Utility;Settings;\nTerminal=false\nStartupNotify=true\n```\n\n## Migration Plan\n\n### Phase 1: Create yamy-gui Executable\n\n1. Create `main_gui.cpp` with QApplication and MainWindowGUI\n2. Create `main_window_gui.cpp/h` with basic UI layout\n3. Create `ipc_client_gui.cpp/h` with IPC wrapper\n4. Build and verify GUI launches and shows \"Not Connected\" state\n\n### Phase 2: Extend IPC Protocol\n\n1. Add GUI-specific message types to `ipc_defs.h`\n2. Implement command handlers in `ipc_control_server.cpp`\n3. Implement message sending in `ipc_client_gui.cpp`\n4. Test IPC communication with mock responses\n\n### Phase 3: Integrate Existing Dialogs\n\n1. Add menu actions in MainWindowGUI for each dialog\n2. Implement slots that instantiate and show existing dialogs\n3. Verify all dialogs work correctly when launched from yamy-gui\n4. Test dialog-to-daemon communication (investigate window → keymap query)\n\n### Phase 4: Refactor Daemon to Headless\n\n1. Modify `main.cpp` to use QCoreApplication instead of QApplication\n2. Remove all SystemTrayAppIndicator code\n3. Remove Qt GUI event loop dependencies\n4. Test daemon runs without GUI/platform plugins loaded\n\n### Phase 5: Testing and Polish\n\n1. Add error handling for all IPC scenarios\n2. Implement auto-reconnection logic\n3. Add status indicators and tooltips\n4. Write automated tests\n5. Update documentation\n\nThis phased approach allows incremental development with testable milestones at each step.\n",
  "fileStats": {
    "size": 14399,
    "lines": 429,
    "lastModified": "2025-12-14T11:13:49.328Z"
  },
  "comments": []
}