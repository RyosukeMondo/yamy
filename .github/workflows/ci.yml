name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install clang tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy

    - name: Check code formatting
      run: |
        echo "## Code Formatting Check" >> $GITHUB_STEP_SUMMARY
        # Find all C++ source files in src/ (excluding third-party/external code)
        FILES=$(find src -name '*.cpp' -o -name '*.h' | grep -v '/third_party/' | grep -v '/external/')

        # Check formatting and report differences
        UNFORMATTED=""
        for FILE in $FILES; do
          if ! clang-format --dry-run --Werror "$FILE" 2>/dev/null; then
            UNFORMATTED="$UNFORMATTED $FILE"
          fi
        done

        if [ -n "$UNFORMATTED" ]; then
          echo "The following files need formatting:" >> $GITHUB_STEP_SUMMARY
          for FILE in $UNFORMATTED; do
            echo "- $FILE" >> $GITHUB_STEP_SUMMARY
          done
          echo ""
          echo "Run 'clang-format -i <file>' or './scripts/format-code.sh' to fix."
          # Report but don't fail initially (set exit 1 to enforce)
          echo "::warning::Code formatting issues found in $(echo $UNFORMATTED | wc -w) files"
        else
          echo "All files are properly formatted." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Run clang-tidy on platform code
      run: |
        echo "## Clang-Tidy Analysis" >> $GITHUB_STEP_SUMMARY
        # Focus on platform/linux code for now (new code should be clean)
        PLATFORM_FILES=$(find src/platform/linux -name '*.cpp' -o -name '*.h' 2>/dev/null || true)

        if [ -n "$PLATFORM_FILES" ]; then
          echo "Analyzing platform/linux code..." >> $GITHUB_STEP_SUMMARY

          # Run clang-tidy and capture output
          TIDY_OUTPUT=""
          for FILE in $PLATFORM_FILES; do
            OUTPUT=$(clang-tidy "$FILE" -- -std=c++17 -I src 2>&1 || true)
            if echo "$OUTPUT" | grep -q "warning:"; then
              TIDY_OUTPUT="$TIDY_OUTPUT\n$OUTPUT"
            fi
          done

          if [ -n "$TIDY_OUTPUT" ]; then
            echo "Clang-tidy found some issues (informational):" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Clang-tidy found potential issues in platform code"
          else
            echo "No issues found in platform/linux code." >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "No platform/linux files to analyze." >> $GITHUB_STEP_SUMMARY
        fi

  build-linux-stub:
    name: Linux Stub Build & Verification
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make \
          libx11-dev libxrandr-dev qtbase5-dev

    - name: Configure CMake
      run: cmake -B build -DBUILD_LINUX_STUB=ON -DBUILD_LINUX_TESTING=OFF

    - name: Build
      run: cmake --build build -j2

    - name: Run Static Analysis
      run: ./scripts/ci_static_analysis.sh

    - name: Check for Win32 type leakage in core
      run: |
        # Count Win32 type usages (excluding template parameters and platform constants)
        # Baseline: 59 usages (includes MSG_* constants in message_constants.h). Goal: reduce over time.
        COUNT=$(grep -r "HWND\|DWORD\|MSG\|WPARAM\|LPARAM" src/core --include="*.cpp" --include="*.h" | grep -v "template.*WPARAM_T\|template.*LPARAM_T" | grep -v "message_constants.h" | wc -l)
        echo "Win32 type leakage count: $COUNT (excluding message_constants.h)"
        if [ "$COUNT" -gt 56 ]; then
          echo "ERROR: Win32 types leaked into src/core (Count: $COUNT, Limit: 56)"
          exit 1
        fi

    - name: Check legacy string usage
      run: |
        bash scripts/track_legacy_strings.sh > metrics.txt
        LEGACY_COUNT=$(grep "TOTAL legacy string usages:" metrics.txt | awk '{print $5}')
        echo "Legacy string usages: $LEGACY_COUNT"
        # Fail if count increases (baseline: 971)
        if [ "$LEGACY_COUNT" -gt 971 ]; then
          echo "ERROR: Legacy string usage increased!"
          exit 1
        fi

    - name: Check #ifdef usage
      run: |
        bash scripts/check_ifdef_usage.sh > /dev/null 2>&1
        IFDEF_COUNT=$(cat .github/metrics/ifdef_count.txt)
        BASELINE=69
        echo "#ifdef _WIN32 total count: $IFDEF_COUNT (baseline: $BASELINE)"
        # Fail if count increases - we want to reduce over time, not add more
        if [ "$IFDEF_COUNT" -gt "$BASELINE" ]; then
          echo "ERROR: #ifdef count increased from $BASELINE to $IFDEF_COUNT"
          echo "Goal: Reduce platform conditionals, not add more"
          echo "See docs/IFDEF_REDUCTION_STRATEGY.md for refactoring guidance"
          exit 1
        fi
        echo "âœ“ #ifdef count acceptable (reducing over time)"

  regression-tests:
    name: Linux Regression Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make \
          libx11-dev libxrandr-dev libudev-dev \
          qtbase5-dev \
          xvfb

    - name: Configure CMake
      run: cmake -B build -DBUILD_LINUX_STUB=ON -DBUILD_REGRESSION_TESTS=ON

    - name: Build regression tests
      run: cmake --build build --target yamy_regression_test --parallel

    - name: Run regression tests with Xvfb
      run: |
        xvfb-run -a ./build/bin/yamy_regression_test --gtest_output=xml:test-results.xml
      env:
        DISPLAY: :99

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results.xml

    - name: Report test summary
      if: always()
      run: |
        if [ -f test-results.xml ]; then
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          # Extract test counts from gtest XML output
          TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          ERRORS=$(grep -o 'errors="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*')
          echo "- Total tests: ${TESTS:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- Failures: ${FAILURES:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: ${ERRORS:-0}" >> $GITHUB_STEP_SUMMARY
        fi

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run on PRs and main branch pushes (not every commit to feature branches)
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make \
          libx11-dev libxrandr-dev libudev-dev \
          qtbase5-dev \
          xvfb lcov bc

    - name: Configure CMake with coverage
      run: |
        cmake -B build \
          -DBUILD_LINUX_STUB=OFF \
          -DBUILD_LINUX_TESTING=OFF \
          -DBUILD_REGRESSION_TESTS=ON \
          -DBUILD_QT_GUI=OFF \
          -DENABLE_COVERAGE=ON \
          -DCMAKE_BUILD_TYPE=Debug

    - name: Build regression tests only
      run: cmake --build build --target yamy_regression_test -j2

    - name: Run tests with coverage (Xvfb)
      run: |
        xvfb-run -a cmake --build build --target coverage
      env:
        DISPLAY: :99

    - name: Extract coverage percentage
      id: coverage
      run: |
        COVERAGE=$(lcov --summary build/coverage/coverage.info 2>&1 | grep 'lines' | grep -oP '[0-9.]+(?=%)' | head -1)
        echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
        echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Line Coverage: ${COVERAGE}%**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full HTML report available in artifacts." >> $GITHUB_STEP_SUMMARY

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: build/coverage/
        retention-days: 30

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: build/coverage/coverage.info
        flags: unittests
        name: yamy-coverage
        fail_ci_if_error: false
        verbose: true
      continue-on-error: true  # Don't fail if Codecov is not configured

    - name: Check coverage threshold
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        THRESHOLD=80
        echo "Coverage: ${COVERAGE}%, Threshold: ${THRESHOLD}%"
        if [ $(echo "${COVERAGE} < ${THRESHOLD}" | bc -l) -eq 1 ]; then
          echo "::warning::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
          # Don't fail the build for now, just warn
          # exit 1
        else
          echo "Coverage meets threshold!"
        fi

  build-windows-mingw:
    name: Windows MinGW Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install MinGW
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 cmake

    - name: Configure CMake
      run: cmake -B build_mingw -DCMAKE_TOOLCHAIN_FILE=scripts/mingw_toolchain.cmake

    - name: Build
      run: cmake --build build_mingw -j2
